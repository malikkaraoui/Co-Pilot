{% extends "admin/base.html" %}
{% block title %}YouTube Recherche Fine - Co-Pilot Admin{% endblock %}

{% block extra_css %}
<style>
  .synthesis-box {
    background: #f1f5f9;
    border-left: 4px solid #3b82f6;
    padding: 16px 20px;
    border-radius: 0 8px 8px 0;
    white-space: pre-wrap;
    font-size: 14px;
    line-height: 1.7;
    max-height: 600px;
    overflow-y: auto;
  }
  .badge-draft { background: #f59e0b; color: #fff; }
  .badge-validated { background: #22c55e; color: #fff; }
  .badge-published { background: #3b82f6; color: #fff; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-0">YouTube Recherche Fine</h2>
  <a href="{{ url_for('admin.youtube') }}" class="btn btn-sm btn-outline-secondary">Retour YouTube Tests</a>
</div>

<!-- Search Form -->
<div class="stat-card mb-4">
  <h5 class="mb-3">Parametres de recherche</h5>
  <form method="post" action="{{ url_for('admin.youtube_fine_search_run') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <label class="form-label">Marque</label>
        <select name="make" class="form-select form-select-sm" id="sel-make" required>
          <option value="">Choisir...</option>
          {% for b in brand_list %}
          <option value="{{ b }}" {% if form_data.make == b %}selected{% endif %}>{{ b }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Modele</label>
        <select name="model" class="form-select form-select-sm" id="sel-model" required>
          <option value="">Choisir marque d'abord...</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Annee</label>
        <select name="year" class="form-select form-select-sm" id="sel-year">
          <option value="">Toutes</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Motorisation</label>
        <select name="fuel" class="form-select form-select-sm">
          <option value="">Toutes</option>
          {% for f in ["diesel", "essence", "hybride", "electrique", "GPL"] %}
          <option value="{{ f }}" {% if form_data.fuel == f %}selected{% endif %}>{{ f|capitalize }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Chevaux</label>
        <select name="hp" class="form-select form-select-sm" id="sel-hp">
          <option value="">Tous</option>
        </select>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label class="form-label">Mots-cles</label>
        <input type="text" name="keywords" class="form-control form-control-sm"
               placeholder="fiabilite, problemes, avis..."
               value="{{ form_data.keywords or '' }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Max videos</label>
        <input type="number" name="max_results" class="form-control form-control-sm"
               value="{{ form_data.max_results or 5 }}" min="1" max="20">
      </div>
      <div class="col-md-3">
        <label class="form-label">LLM</label>
        <select name="llm_model" class="form-select form-select-sm">
          {% if ollama_models %}
            {% for m in ollama_models %}
            <option value="{{ m }}" {% if form_data.llm_model == m %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
          {% else %}
            <option value="">Ollama indisponible</option>
          {% endif %}
        </select>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100"
                {% if not ollama_models %}disabled title="Ollama non connecte"{% endif %}>
          Rechercher &amp; Synthetiser
        </button>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-12">
        <label class="form-label">Prompt LLM</label>
        <textarea name="prompt" class="form-control form-control-sm" rows="5">{{ form_data.prompt or default_prompt }}</textarea>
      </div>
    </div>
  </form>
</div>

<!-- Results (after POST) -->
{% if result %}
<div class="stat-card mb-4">
  <h5 class="mb-3">Resultat de la recherche</h5>
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="stat-card" style="background:#f8fafc">
        <div class="stat-value">{{ result.videos_found }}</div>
        <div class="stat-label">Videos trouvees</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card" style="background:#f8fafc">
        <div class="stat-value" style="color:#22c55e">{{ result.transcripts_ok }}</div>
        <div class="stat-label">Transcripts extraits</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card" style="background:#f8fafc">
        <div class="stat-value" style="color:#8b5cf6">{{ "{:,}".format(result.total_chars).replace(",", " ") }}</div>
        <div class="stat-label">Caracteres concatenes</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card" style="background:#f8fafc">
        <div class="stat-value">{{ result.query[:30] }}{% if result.query|length > 30 %}...{% endif %}</div>
        <div class="stat-label">Query YouTube</div>
      </div>
    </div>
  </div>

  {% if result.synthesis_text %}
  <h6 class="mb-2">Synthese LLM ({{ result.llm_model }})</h6>
  <div class="synthesis-box mb-3">{{ result.synthesis_text }}</div>

  {% if result.synthesis_id %}
  <div class="d-flex gap-2">
    <form method="post" action="{{ url_for('admin.youtube_synthesis_validate', synthesis_id=result.synthesis_id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn btn-sm btn-success">Valider la synthese</button>
    </form>
    <span class="badge badge-draft align-self-center">Draft</span>
  </div>
  {% endif %}
  {% elif result.transcripts_ok == 0 %}
  <div class="alert alert-warning mb-0">
    Aucun transcript extrait. La synthese LLM n'a pas pu etre generee.
  </div>
  {% endif %}
</div>
{% endif %}

<!-- Previous syntheses -->
{% if syntheses %}
<div class="stat-card">
  <h5 class="mb-3">Syntheses precedentes</h5>
  <div class="table-responsive">
    <table class="table table-sm table-hover mb-0">
      <thead>
        <tr>
          <th>Vehicule</th>
          <th>LLM</th>
          <th>Status</th>
          <th class="text-end">Chars</th>
          <th>Date</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for s in syntheses %}
        <tr>
          <td><strong>{{ s.make }}</strong> {{ s.model }} {% if s.year %}({{ s.year }}){% endif %}</td>
          <td>{{ s.llm_model }}</td>
          <td><span class="badge badge-{{ s.status }}">{{ s.status }}</span></td>
          <td class="text-end">{{ "{:,}".format(s.raw_transcript_chars or 0).replace(",", " ") }}</td>
          <td style="font-size:12px">{{ s.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
          <td class="text-center">
            {% if s.status == 'draft' %}
            <form method="post" action="{{ url_for('admin.youtube_synthesis_validate', synthesis_id=s.id) }}" style="display:inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn-sm btn-outline-success">Valider</button>
            </form>
            {% elif s.status == 'validated' %}
            <span class="text-success" style="font-size:12px">Validee</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
(function() {
  var catalog = {{ vehicle_catalog|tojson }};
  var selMake  = document.getElementById('sel-make');
  var selModel = document.getElementById('sel-model');
  var selYear  = document.getElementById('sel-year');
  var selHp    = document.getElementById('sel-hp');

  /* Valeurs pre-selectionnees (restaurees apres POST) */
  var prevModel = {{ (form_data.model or "")|tojson }};
  var prevYear  = {{ (form_data.year or "")|tojson }};
  var prevHp    = {{ (form_data.hp or "")|tojson }};

  function clearSelect(sel) {
    while (sel.options.length > 0) { sel.remove(0); }
  }

  function addOption(sel, value, text, selected) {
    var opt = document.createElement('option');
    opt.value = value;
    opt.textContent = text;
    if (selected) { opt.selected = true; }
    sel.appendChild(opt);
  }

  function populateSelect(sel, options, placeholder, selectedValue) {
    clearSelect(sel);
    addOption(sel, '', placeholder, false);
    for (var i = 0; i < options.length; i++) {
      var val = options[i];
      addOption(sel, val, val, String(val) === String(selectedValue));
    }
  }

  function onMakeChange() {
    var brand = selMake.value;
    var models = (brand && catalog[brand]) ? Object.keys(catalog[brand]).sort() : [];
    populateSelect(selModel, models, models.length ? 'Choisir...' : 'Choisir marque d\'abord...', prevModel);
    onModelChange();
  }

  function onModelChange() {
    var brand = selMake.value;
    var model = selModel.value;
    var info = (brand && model && catalog[brand] && catalog[brand][model]) ? catalog[brand][model] : null;

    var years = info ? info.years.slice().reverse() : [];
    populateSelect(selYear, years, 'Toutes', prevYear);

    var hpValues = info ? info.hp : [];
    populateSelect(selHp, hpValues, 'Tous', prevHp);
  }

  selMake.addEventListener('change', onMakeChange);
  selModel.addEventListener('change', onModelChange);

  /* Init on page load (restore state after POST) */
  if (selMake.value) {
    onMakeChange();
  }
})();
</script>
{% endblock %}
