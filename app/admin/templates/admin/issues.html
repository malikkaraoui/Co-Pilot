{% extends "admin/base.html" %}
{% block title %}Issues collecte - Co-Pilot Admin{% endblock %}

{% block content %}
<h2 class="mb-4">Issues collecte</h2>
<p class="text-muted mb-4">File d'attente des jobs de collecte argus a executer par les extensions Chrome.</p>

<!-- Onglets LBC / AS24 -->
<ul class="nav nav-tabs mb-4">
  <li class="nav-item">
    <a class="nav-link {% if site == 'lbc' %}active{% endif %}"
       href="{{ url_for('admin.issues', site='lbc') }}">LeBonCoin</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if site == 'as24' %}active{% endif %}"
       href="{{ url_for('admin.issues', site='as24') }}">AutoScout24</a>
  </li>
</ul>

<!-- Stats resume -->
<div class="row g-3 mb-4">
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value" style="color: #3b82f6;">{{ pending }}</div>
      <div class="stat-label">En attente</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value" style="color: #f59e0b;">{{ assigned }}</div>
      <div class="stat-label">Assignes</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value" style="color: #22c55e;">{{ done }}</div>
      <div class="stat-label">Completes</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value" style="color: #ef4444;">{{ failed }}</div>
      <div class="stat-label">Echoues</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value">{{ total }}</div>
      <div class="stat-label">Total</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value" style="color: {% if completion_rate >= 80 %}#22c55e{% elif completion_rate >= 50 %}#f59e0b{% else %}#ef4444{% endif %};">{{ completion_rate }}%</div>
      <div class="stat-label">Taux completion</div>
    </div>
  </div>
</div>

<!-- Filtres + Actions -->
<div class="stat-card mb-4">
  <div class="row g-2 align-items-end">
    <div class="col-md-8">
      <form method="get" class="row g-2 align-items-end">
        <input type="hidden" name="site" value="{{ site }}">
        <div class="col-md-3">
          <label class="form-label mb-1" style="font-size:13px">Status</label>
          <select name="status" class="form-select form-select-sm">
            <option value="">Tous</option>
            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>En attente</option>
            <option value="assigned" {% if status_filter == 'assigned' %}selected{% endif %}>Assignes</option>
            <option value="done" {% if status_filter == 'done' %}selected{% endif %}>Completes</option>
            <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>Echoues</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label mb-1" style="font-size:13px">Marque</label>
          <select name="make" class="form-select form-select-sm">
            <option value="">Toutes</option>
            {% for m in make_list %}
            <option value="{{ m }}" {% if m == make_filter %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label mb-1" style="font-size:13px">Priorite</label>
          <select name="priority" class="form-select form-select-sm">
            <option value="">Toutes</option>
            <option value="1" {% if priority_filter == '1' %}selected{% endif %}>P1 - Regions</option>
            <option value="2" {% if priority_filter == '2' %}selected{% endif %}>P2 - Fuel</option>
            <option value="3" {% if priority_filter == '3' %}selected{% endif %}>P3 - Boite</option>
            <option value="4" {% if priority_filter == '4' %}selected{% endif %}>P4 - Annee</option>
          </select>
        </div>
        <div class="col-md-3">
          <button type="submit" class="btn btn-sm btn-primary">Filtrer</button>
          {% if status_filter or make_filter or priority_filter %}
          <a href="{{ url_for('admin.issues', site=site) }}" class="btn btn-sm btn-outline-secondary">Reset</a>
          {% endif %}
        </div>
      </form>
    </div>
    <div class="col-md-2 text-end">
      {% if failed > 0 %}
      <form method="post" action="{{ url_for('admin.purge_failed_jobs') }}">
        <input type="hidden" name="site" value="{{ site }}">
        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Remettre {{ failed }} jobs echoues en attente ?')">
          Purger failed
        </button>
      </form>
      {% endif %}
    </div>
    <div class="col-md-2 text-end text-muted" style="font-size:13px">
      {{ total_results }} resultat{{ 's' if total_results != 1 else '' }}
    </div>
  </div>
</div>

<!-- Table -->
<div class="stat-card">
  {% if records %}
  <div class="table-responsive">
    <table class="table table-sm table-hover mb-0">
      <thead>
        <tr>
          <th>Priorite</th>
          <th>Vehicule</th>
          <th>Motorisation</th>
          <th>Region</th>
          <th class="text-center">Status</th>
          <th>Cree le</th>
          <th>Source</th>
          <th class="text-center">Tentatives</th>
        </tr>
      </thead>
      <tbody>
        {% for j in records %}
        {% set priority_labels = {1: 'P1 Region', 2: 'P2 Fuel', 3: 'P3 Boite', 4: 'P4 Annee'} %}
        {% set priority_colors = {1: 'primary', 2: 'info', 3: 'warning', 4: 'secondary'} %}
        {% set status_colors = {'pending': 'primary', 'assigned': 'warning', 'done': 'success', 'failed': 'danger'} %}
        <tr>
          <td>
            <span class="badge bg-{{ priority_colors.get(j.priority, 'secondary') }}">
              {{ priority_labels.get(j.priority, 'P' ~ j.priority) }}
            </span>
          </td>
          <td>
            <strong>{{ j.make }}</strong> {{ j.model }}
            <span class="text-muted" style="font-size:12px">{{ j.year }}</span>
          </td>
          <td style="font-size:12px">
            {% if j.fuel %}<span class="badge bg-secondary">{{ j.fuel }}</span>{% endif %}
            {% if j.hp_range %}<span class="badge bg-info text-dark">{{ j.hp_range }}ch</span>{% endif %}
            {% if j.gearbox %}<span class="badge bg-light text-dark">{{ j.gearbox }}</span>{% endif %}
          </td>
          <td>{{ j.region }}</td>
          <td class="text-center">
            <span class="badge bg-{{ status_colors.get(j.status, 'secondary') }}{% if j.status == 'assigned' %} text-dark{% endif %}">
              {{ j.status }}
            </span>
          </td>
          <td style="font-size:12px; white-space:nowrap">
            {{ j.created_at|localdatetime }}
          </td>
          <td style="font-size:11px; max-width:200px" class="text-truncate" title="{{ j.source_vehicle or '' }}">
            {{ j.source_vehicle or '-' }}
          </td>
          <td class="text-center">
            {% if j.attempts > 0 %}
            <span class="badge bg-{{ 'danger' if j.attempts >= 3 else 'warning text-dark' }}">{{ j.attempts }}/3</span>
            {% else %}
            <span class="text-muted">0</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if total_pages > 1 %}
  <nav class="mt-3">
    <ul class="pagination pagination-sm justify-content-center mb-0">
      {% for p in range(1, total_pages + 1) %}
      <li class="page-item {% if p == page %}active{% endif %}">
        <a class="page-link" href="?site={{ site }}&page={{ p }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if make_filter %}&make={{ make_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}">{{ p }}</a>
      </li>
      {% endfor %}
    </ul>
  </nav>
  {% endif %}

  {% else %}
  <p class="text-muted text-center py-4 mb-0">Aucun job de collecte dans la file d'attente.</p>
  {% endif %}
</div>
{% endblock %}
