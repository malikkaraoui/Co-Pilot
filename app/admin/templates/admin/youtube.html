{% extends "admin/base.html" %}
{% block title %}YouTube Tests - Co-Pilot Admin{% endblock %}

{% block extra_css %}
<style>
  .badge-extracted { background: #22c55e; color: #fff; }
  .badge-pending { background: #f59e0b; color: #fff; }
  .badge-no_subtitles { background: #9ca3af; color: #fff; }
  .badge-error, .badge-failed { background: #ef4444; color: #fff; }
  .badge-archived { background: #64748b; color: #fff; }
  .yt-title { max-width: 320px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-0">YouTube Tests</h2>
  <form method="post" action="{{ url_for('admin.youtube_search') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="input-group input-group-sm">
      <select name="vehicle_id" class="form-select form-select-sm" style="max-width:220px" required>
        <option value="">Choisir un vehicule...</option>
        {% for v in vehicle_list %}
        <option value="{{ v.id }}">{{ v.brand }} {{ v.model }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="btn btn-sm btn-primary">Rechercher &amp; Extraire</button>
    </div>
  </form>
</div>

<!-- Stat cards -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="stat-card">
      <div class="stat-value">{{ total_videos }}</div>
      <div class="stat-label">Videos en base</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card">
      <div class="stat-value" style="color: #22c55e;">{{ total_transcripts }}</div>
      <div class="stat-label">Transcripts extraits</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card">
      <div class="stat-value" style="color: #8b5cf6;">{{ "{:,}".format(total_chars).replace(",", " ") }}</div>
      <div class="stat-label">Caracteres totaux</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card">
      <div class="stat-value">{{ coverage_pct }}%</div>
      <div class="stat-label">Couverture vehicules</div>
    </div>
  </div>
</div>

<!-- Filtres -->
<div class="stat-card mb-4">
  <form method="get" class="row g-2 align-items-end">
    <div class="col-md-3">
      <label class="form-label mb-1" style="font-size:13px">Vehicule</label>
      <select name="vehicle_id" class="form-select form-select-sm">
        <option value="">Tous</option>
        {% for v in vehicle_list %}
        <option value="{{ v.id }}" {% if v.id|string == vehicle_filter %}selected{% endif %}>{{ v.brand }} {{ v.model }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label mb-1" style="font-size:13px">Status</label>
      <select name="status" class="form-select form-select-sm">
        <option value="">Tous</option>
        <option value="extracted" {% if status_filter == 'extracted' %}selected{% endif %}>Extrait</option>
        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>En attente</option>
        <option value="no_subtitles" {% if status_filter == 'no_subtitles' %}selected{% endif %}>Pas de sous-titres</option>
        <option value="error" {% if status_filter == 'error' %}selected{% endif %}>Erreur</option>
        <option value="archived" {% if status_filter == 'archived' %}selected{% endif %}>Archive</option>
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-sm btn-primary">Filtrer</button>
      {% if vehicle_filter or status_filter %}
      <a href="{{ url_for('admin.youtube') }}" class="btn btn-sm btn-outline-secondary">Reset</a>
      {% endif %}
    </div>
    <div class="col-md-5 text-end text-muted" style="font-size:13px">
      {{ total_results }} resultat{{ 's' if total_results != 1 else '' }}
    </div>
  </form>
</div>

<!-- Table -->
<div class="stat-card">
  {% if videos %}
  <div class="table-responsive">
    <table class="table table-sm table-hover mb-0">
      <thead>
        <tr>
          <th>Video</th>
          <th>Vehicule</th>
          <th class="text-center">Status</th>
          <th class="text-end">Caracteres</th>
          <th>Extraction</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for v in videos %}
        <tr {% if v.is_archived %}style="opacity: 0.5"{% endif %}>
          <td>
            <div class="yt-title">
              {% if v.is_featured %}<span class="badge bg-warning text-dark" style="font-size:10px">FEATURED</span> {% endif %}
              <a href="https://youtube.com/watch?v={{ v.video_id }}" target="_blank" rel="noopener"
                 title="{{ v.title }}">{{ v.title }}</a>
            </div>
            <div class="text-muted" style="font-size:11px">{{ v.channel_name or '' }}</div>
          </td>
          <td>
            {% if v.vehicle %}
            <strong>{{ v.vehicle.brand }}</strong> {{ v.vehicle.model }}
            {% else %}
            <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td class="text-center">
            {% if v.is_archived %}
              <span class="badge badge-archived">Archive</span>
            {% elif v.transcript %}
              <span class="badge badge-{{ v.transcript.status }}">{{ v.transcript.status }}</span>
            {% else %}
              <span class="badge badge-pending">pending</span>
            {% endif %}
          </td>
          <td class="text-end">
            {% if v.transcript and v.transcript.char_count %}
              {{ "{:,}".format(v.transcript.char_count).replace(",", " ") }}
            {% else %}
              -
            {% endif %}
          </td>
          <td style="font-size:12px">
            {% if v.transcript and v.transcript.extracted_at %}
              {{ v.transcript.extracted_at|localdatetime }}
            {% else %}
              -
            {% endif %}
          </td>
          <td class="text-center">
            <div class="btn-group btn-group-sm">
              <a href="{{ url_for('admin.youtube_detail', video_id=v.id) }}"
                 class="btn btn-outline-secondary" title="Detail">Voir</a>
              {% if not v.transcript or v.transcript.status != 'extracted' %}
              <form method="post" action="{{ url_for('admin.youtube_extract', video_id=v.id) }}" style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-outline-primary" title="Extraire">Extraire</button>
              </form>
              {% endif %}
              <form method="post" action="{{ url_for('admin.youtube_featured', video_id=v.id) }}" style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-{% if v.is_featured %}warning{% else %}outline-dark{% endif %}"
                        title="{% if v.is_featured %}Retirer featured{% else %}Marquer featured{% endif %}">
                  &#9733;
                </button>
              </form>
              <form method="post" action="{{ url_for('admin.youtube_archive', video_id=v.id) }}" style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-outline-{% if v.is_archived %}success{% else %}warning{% endif %}"
                        title="{% if v.is_archived %}Desarchiver{% else %}Archiver{% endif %}">
                  {% if v.is_archived %}Restaurer{% else %}Archiver{% endif %}
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if total_pages > 1 %}
  <nav class="mt-3">
    <ul class="pagination pagination-sm justify-content-center mb-0">
      {% if page > 1 %}
      <li class="page-item">
        <a class="page-link" href="?vehicle_id={{ vehicle_filter }}&status={{ status_filter }}&page={{ page - 1 }}">&laquo;</a>
      </li>
      {% endif %}
      {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
        <li class="page-item active"><span class="page-link">{{ p }}</span></li>
        {% elif (p - page)|abs <= 2 or p == 1 or p == total_pages %}
        <li class="page-item">
          <a class="page-link" href="?vehicle_id={{ vehicle_filter }}&status={{ status_filter }}&page={{ p }}">{{ p }}</a>
        </li>
        {% elif (p - page)|abs == 3 %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
      {% endfor %}
      {% if page < total_pages %}
      <li class="page-item">
        <a class="page-link" href="?vehicle_id={{ vehicle_filter }}&status={{ status_filter }}&page={{ page + 1 }}">&raquo;</a>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

  {% else %}
  <p class="text-muted text-center py-5">
    Aucune video{% if vehicle_filter or status_filter %} pour ces filtres{% endif %}.<br>
    <small>Utilisez le bouton "Rechercher &amp; Extraire" pour ajouter des videos.</small>
  </p>
  {% endif %}
</div>
{% endblock %}
