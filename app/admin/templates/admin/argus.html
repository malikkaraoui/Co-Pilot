{% extends "admin/base.html" %}
{% block title %}Argus maison - Co-Pilot Admin{% endblock %}

{% block content %}
<h2 class="mb-4">Argus maison</h2>
<p class="text-muted mb-4">Prix du marche collectes par les utilisateurs de l'extension Chrome (crowdsourcing).</p>

<!-- Stats resume -->
<div class="row g-3 mb-4">
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value">{{ total_refs }}</div>
      <div class="stat-label">References prix</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value" style="color: #22c55e;">{{ fresh_refs }}</div>
      <div class="stat-label">Frais (< 24h)</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value" style="color: #f59e0b;">{{ stale_refs }}</div>
      <div class="stat-label">A rafraichir</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value" style="color: #8b5cf6;">{{ total_samples }}</div>
      <div class="stat-label">Annonces collectees</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value">{{ distinct_makes }}</div>
      <div class="stat-label">Marques couvertes</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value">{{ distinct_regions }}</div>
      <div class="stat-label">Regions couvertes</div>
    </div>
  </div>
</div>

<!-- Filtres -->
<div class="stat-card mb-4">
  <form method="get" class="row g-2 align-items-end">
    <div class="col-md-3">
      <label class="form-label mb-1" style="font-size:13px">Marque</label>
      <select name="make" class="form-select form-select-sm">
        <option value="">Toutes</option>
        {% for m in make_list %}
        <option value="{{ m }}" {% if m == make_filter %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label mb-1" style="font-size:13px">Region</label>
      <select name="region" class="form-select form-select-sm">
        <option value="">Toutes</option>
        {% for r in region_list %}
        <option value="{{ r }}" {% if r == region_filter %}selected{% endif %}>{{ r }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-sm btn-primary">Filtrer</button>
      {% if make_filter or region_filter %}
      <a href="{{ url_for('admin.argus') }}" class="btn btn-sm btn-outline-secondary">Reset</a>
      {% endif %}
    </div>
    <div class="col-md-4 text-end text-muted" style="font-size:13px">
      {{ total_results }} resultat{{ 's' if total_results != 1 else '' }}
    </div>
  </form>
</div>

<!-- Table des prix -->
<div class="stat-card">
  {% if records %}
  <div class="table-responsive">
    <table class="table table-sm table-hover mb-0">
      <thead>
        <tr>
          <th>Collecte</th>
          <th>Vehicule</th>
          <th>Region</th>
          <th class="text-end">Median</th>
          <th class="text-end">Min</th>
          <th class="text-end">Max</th>
          <th class="text-end">Moyenne</th>
          <th class="text-end">Ecart-type</th>
          <th class="text-center">Annonces</th>
          <th class="text-center">Fraicheur</th>
        </tr>
      </thead>
      <tbody>
        {% for m in records %}
        {% set is_fresh = m.refresh_after > now %}
        <tr>
          <td style="font-size:12px; white-space:nowrap">
            {{ m.collected_at.strftime('%d/%m/%Y %H:%M') if m.collected_at else '-' }}
          </td>
          <td>
            <strong>{{ m.make }}</strong> {{ m.model }}
            <span class="text-muted" style="font-size:12px">{{ m.year }}</span>
          </td>
          <td>{{ m.region }}</td>
          <td class="text-end"><strong>{{ "{:,}".format(m.price_median).replace(",", " ") }} &euro;</strong></td>
          <td class="text-end" style="font-size:12px">{{ "{:,}".format(m.price_min).replace(",", " ") }} &euro;</td>
          <td class="text-end" style="font-size:12px">{{ "{:,}".format(m.price_max).replace(",", " ") }} &euro;</td>
          <td class="text-end" style="font-size:12px">{{ "{:,}".format(m.price_mean).replace(",", " ") }} &euro;</td>
          <td class="text-end" style="font-size:12px">{{ "{:,.0f}".format(m.price_std).replace(",", " ") }} &euro;</td>
          <td class="text-center"><span class="badge bg-primary">{{ m.sample_count }}</span></td>
          <td class="text-center">
            {% if is_fresh %}
              <span class="badge bg-success">Frais</span>
            {% else %}
              <span class="badge bg-warning text-dark">A rafraichir</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if total_pages > 1 %}
  <nav class="mt-3">
    <ul class="pagination pagination-sm justify-content-center mb-0">
      {% if page > 1 %}
      <li class="page-item">
        <a class="page-link" href="?make={{ make_filter }}&region={{ region_filter }}&page={{ page - 1 }}">&laquo;</a>
      </li>
      {% endif %}
      {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
        <li class="page-item active"><span class="page-link">{{ p }}</span></li>
        {% elif (p - page)|abs <= 2 or p == 1 or p == total_pages %}
        <li class="page-item">
          <a class="page-link" href="?make={{ make_filter }}&region={{ region_filter }}&page={{ p }}">{{ p }}</a>
        </li>
        {% elif (p - page)|abs == 3 %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
      {% endfor %}
      {% if page < total_pages %}
      <li class="page-item">
        <a class="page-link" href="?make={{ make_filter }}&region={{ region_filter }}&page={{ page + 1 }}">&raquo;</a>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

  {% else %}
  <p class="text-muted text-center py-5">
    Aucun prix collecte{% if make_filter or region_filter %} pour ces filtres{% endif %}.<br>
    <small>Les prix seront collectes automatiquement par les utilisateurs de l'extension.</small>
  </p>
  {% endif %}
</div>
{% endblock %}
