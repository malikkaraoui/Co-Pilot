{% extends "admin/base.html" %}
{% block title %}Argus maison - Co-Pilot Admin{% endblock %}

{% block content %}
<h2 class="mb-4">Argus maison</h2>
<p class="text-muted mb-4">Prix du marche collectes par les utilisateurs de l'extension Chrome (crowdsourcing).</p>

<!-- Stats resume -->
<div class="row g-3 mb-4">
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value">{{ total_refs }}</div>
      <div class="stat-label">References prix</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value" style="color: #22c55e;">{{ fresh_refs }}</div>
      <div class="stat-label">Frais (< 24h)</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value" style="color: #f59e0b;">{{ stale_refs }}</div>
      <div class="stat-label">A rafraichir</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value" style="color: #8b5cf6;">{{ total_samples }}</div>
      <div class="stat-label">Annonces collectees</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value">{{ distinct_makes }}</div>
      <div class="stat-label">Marques couvertes</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value">{{ distinct_regions }}</div>
      <div class="stat-label">Regions couvertes</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value" style="color: {% if validation_rate >= 80 %}#22c55e{% elif validation_rate >= 50 %}#f59e0b{% else %}#ef4444{% endif %};">
        {{ validation_rate }}%
      </div>
      <div class="stat-label">Valides par LBC ({{ total_with_lbc }})</div>
    </div>
  </div>
</div>

<!-- Filtres -->
<div class="stat-card mb-4">
  <form method="get" class="row g-2 align-items-end">
    <div class="col-md-3">
      <label class="form-label mb-1" style="font-size:13px">Marque</label>
      <select name="make" class="form-select form-select-sm">
        <option value="">Toutes</option>
        {% for m in make_list %}
        <option value="{{ m }}" {% if m == make_filter %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label mb-1" style="font-size:13px">Region</label>
      <select name="region" class="form-select form-select-sm">
        <option value="">Toutes</option>
        {% for r in region_list %}
        <option value="{{ r }}" {% if r == region_filter %}selected{% endif %}>{{ r }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-sm btn-primary">Filtrer</button>
      {% if make_filter or region_filter %}
      <a href="{{ url_for('admin.argus') }}" class="btn btn-sm btn-outline-secondary">Reset</a>
      {% endif %}
    </div>
    <div class="col-md-4 text-end text-muted" style="font-size:13px">
      {{ total_results }} resultat{{ 's' if total_results != 1 else '' }}
    </div>
  </form>
</div>

<!-- Table des prix -->
<div class="stat-card">
  {% if records %}
  <div class="table-responsive">
    <table class="table table-sm table-hover mb-0">
      <thead>
        <tr>
          <th>Collecte</th>
          <th>Vehicule</th>
          <th>Motorisation</th>
          <th>Region</th>
          <th class="text-end" title="Moyenne Interquartile (50% central)">IQR Mean</th>
          <th class="text-end" title="Percentile 25 (bonne affaire)">P25</th>
          <th class="text-end">Median</th>
          <th class="text-end" title="Percentile 75 (cher)">P75</th>
          <th class="text-end">Min</th>
          <th class="text-end">Max</th>
          <th class="text-center">Annonces</th>
          <th class="text-center">Precision</th>
          <th class="text-center">Fraicheur</th>
          <th class="text-center">Validation LBC</th>
          <th class="text-center">Detail</th>
        </tr>
      </thead>
      <tbody>
        {% for m in records %}
        {% set is_fresh = m.refresh_after > now %}
        {% set details = m.get_calculation_details() %}
        <tr>
          <td style="font-size:12px; white-space:nowrap">
            {{ (m.collected_at|localtime).strftime('%d/%m/%Y %H:%M') if m.collected_at else '-' }}
          </td>
          <td>
            <strong>{{ m.make }}</strong> {{ m.model }}
            <span class="text-muted" style="font-size:12px">{{ m.year }}</span>
          </td>
          <td style="font-size:12px">
            {% if m.fuel %}<span class="badge bg-secondary">{{ m.fuel }}</span>{% endif %}
            {% if m.hp_range %}<span class="badge bg-info text-dark">{{ m.hp_range }}ch</span>{% endif %}
            {% if m.fiscal_hp %}<span class="text-muted">{{ m.fiscal_hp }}cv</span>{% endif %}
          </td>
          <td>{{ m.region }}</td>
          <td class="text-end"><strong>{{ "{:,}".format(m.price_iqr_mean or m.price_median).replace(",", " ") }} &euro;</strong></td>
          <td class="text-end" style="font-size:12px; color:#22c55e">{{ "{:,}".format(m.price_p25 or m.price_min).replace(",", " ") }} &euro;</td>
          <td class="text-end" style="font-size:12px">{{ "{:,}".format(m.price_median).replace(",", " ") }} &euro;</td>
          <td class="text-end" style="font-size:12px; color:#f59e0b">{{ "{:,}".format(m.price_p75 or m.price_max).replace(",", " ") }} &euro;</td>
          <td class="text-end" style="font-size:12px">{{ "{:,}".format(m.price_min).replace(",", " ") }} &euro;</td>
          <td class="text-end" style="font-size:12px">{{ "{:,}".format(m.price_max).replace(",", " ") }} &euro;</td>
          <td class="text-center"><span class="badge bg-primary">{{ m.sample_count }}</span></td>
          <td class="text-center">
            {% if m.precision %}
              {% set prec_colors = {5: 'success', 4: 'success', 3: 'info', 2: 'warning', 1: 'danger'} %}
              {% set prec_labels = {5: 'Tres precis', 4: 'Precis', 3: 'Correct', 2: 'Approx.', 1: 'Estimatif'} %}
              <span class="badge bg-{{ prec_colors.get(m.precision, 'secondary') }}" title="{{ prec_labels.get(m.precision, '') }}">
                {{ '\u2605' * m.precision }}{{ '\u2606' * (5 - m.precision) }}
              </span>
            {% else %}
              <span class="text-muted" style="font-size:11px">-</span>
            {% endif %}
          </td>
          <td class="text-center">
            {% if is_fresh %}
              <span class="badge bg-success">Frais</span>
            {% else %}
              <span class="badge bg-warning text-dark">A rafraichir</span>
            {% endif %}
          </td>
          <td class="text-center">
            {% if m._validation == "valid" %}
              <span class="badge bg-success" title="IQR mean dans la fourchette LBC">Valide</span>
            {% elif m._validation == "proche" %}
              <span class="badge bg-warning text-dark" title="IQR mean proche fourchette LBC (+-15%)">Proche</span>
            {% elif m._validation == "ecart" %}
              <span class="badge bg-danger" title="IQR mean hors fourchette LBC (>15%)">Ecart</span>
            {% else %}
              <span class="text-muted" style="font-size:11px">-</span>
            {% endif %}
          </td>
          <td class="text-center">
            {% if details %}
            <button class="btn btn-sm btn-outline-secondary"
                    data-bs-toggle="modal"
                    data-bs-target="#detailModal{{ m.id }}"
                    title="Voir le detail du calcul">
              <small>Voir</small>
            </button>
            {% else %}
            <span class="text-muted" style="font-size:11px">-</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Modales de detail -->
  {% for m in records %}
  {% set details = m.get_calculation_details() %}
  {% if details %}
  <div class="modal fade" id="detailModal{{ m.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            Detail du calcul &mdash; {{ m.make }} {{ m.model }} {{ m.year }} ({{ m.region }})
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <!-- Methode + Precision -->
          <div class="mb-3">
            <span class="badge bg-info">Methode : {{ details.get('method', 'inconnue') | upper }}</span>
            <span class="badge bg-secondary">{{ details.get('raw_count', '?') }} annonces collectees</span>
            <span class="badge bg-success">{{ details.get('kept_count', '?') }} retenues</span>
            {% if details.get('excluded_count', 0) > 0 %}
            <span class="badge bg-danger">{{ details.get('excluded_count', 0) }} exclues</span>
            {% endif %}
            {% if details.get('precision') %}
            {% set dp = details.get('precision') %}
            {% set dp_colors = {5: 'success', 4: 'success', 3: 'info', 2: 'warning', 1: 'danger'} %}
            {% set dp_labels = {5: 'Tres precis', 4: 'Precis', 3: 'Correct', 2: 'Approx.', 1: 'Estimatif'} %}
            <span class="badge bg-{{ dp_colors.get(dp, 'secondary') }}">
              Precision : {{ '\u2605' * dp }}{{ '\u2606' * (5 - dp) }} {{ dp }}/5 &ndash; {{ dp_labels.get(dp, '') }}
            </span>
            {% endif %}
          </div>

          <!-- Cascade de recherche (transparence) -->
          {% if details.get('search_steps') %}
          <div class="mb-3">
            <h6>
              Cascade de recherche ({{ details.get('search_steps')|length }} etape{{ 's' if details.get('search_steps')|length > 1 else '' }})
            </h6>
            <div class="table-responsive">
              <table class="table table-sm mb-0" style="font-size:12px">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Precision</th>
                    <th>Zone</th>
                    <th>Annees</th>
                    <th>Filtres</th>
                    <th class="text-center">Annonces</th>
                    <th>Statut</th>
                    <th>URL</th>
                  </tr>
                </thead>
                <tbody>
                  {% for s in details.get('search_steps', []) %}
                  <tr class="{{ 'table-success' if s.get('was_selected') else '' }}">
                    <td><strong>{{ s.get('step', '?') }}</strong></td>
                    <td>
                      {% set sp = s.get('precision', 0) %}
                      {% set sp_colors = {5: 'success', 4: 'success', 3: 'info', 2: 'warning', 1: 'danger'} %}
                      <span class="badge bg-{{ sp_colors.get(sp, 'secondary') }}">
                        {{ '\u2605' * sp }}{{ '\u2606' * (5 - sp) }}
                      </span>
                    </td>
                    <td>
                      {% set loc_labels = {'geo': 'Geo (30km)', 'region': 'Region', 'national': 'National'} %}
                      {{ loc_labels.get(s.get('location_type', ''), s.get('location_type', '?')) }}
                    </td>
                    <td>&plusmn;{{ s.get('year_spread', '?') }} an{{ 's' if s.get('year_spread', 0) > 1 else '' }}</td>
                    <td>
                      {% for f in s.get('filters_applied', []) %}
                      <span class="badge bg-secondary bg-opacity-50" style="font-size:10px">{{ f }}</span>
                      {% endfor %}
                      {% if not s.get('filters_applied') %}
                      <span class="text-muted" style="font-size:11px">aucun</span>
                      {% endif %}
                    </td>
                    <td class="text-center">
                      {% if s.get('was_selected') %}
                      <span class="badge bg-success">{{ s.get('ads_found', 0) }}</span>
                      {% elif s.get('ads_found', 0) > 0 %}
                      <span class="badge bg-warning text-dark">{{ s.get('ads_found', 0) }}</span>
                      {% else %}
                      <span class="badge bg-danger">0</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if s.get('was_selected') %}
                      <span style="color:#22c55e; font-weight:bold">Retenu</span>
                      {% else %}
                      <span style="color:#f59e0b; font-size:11px">{{ s.get('reason', 'Insuffisant') }}</span>
                      {% endif %}
                    </td>
                    <td>
                      <a href="{{ s.get('url', '#') }}" target="_blank" rel="noopener"
                         class="btn btn-sm btn-outline-secondary" style="font-size:10px; padding:1px 6px"
                         title="{{ s.get('url', '') }}">
                        Ouvrir
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endif %}

          <!-- Bornes IQR -->
          <div class="mb-3 p-2" style="background:#f8f9fa; border-radius:8px">
            <strong>Bornes IQR :</strong>
            {{ "{:,.0f}".format(details.get('iqr_low', 0)).replace(",", " ") }} &euro;
            &mdash;
            {{ "{:,.0f}".format(details.get('iqr_high', 0)).replace(",", " ") }} &euro;
            <br>
            <small class="text-muted">Les prix en dehors de ces bornes sont exclus du calcul (outliers).</small>
          </div>

          <!-- Prix gardes -->
          <div class="mb-3">
            <h6>Prix retenus ({{ details.get('kept_count', 0) }})</h6>
            {% if details.get('kept_details') %}
            <div class="table-responsive" style="max-height:300px; overflow-y:auto">
              <table class="table table-sm table-striped mb-0" style="font-size:12px">
                <thead class="table-light">
                  <tr>
                    <th>Prix</th>
                    <th>Annee</th>
                    <th>Km</th>
                    <th>Motorisation</th>
                  </tr>
                </thead>
                <tbody>
                  {% for d in details.get('kept_details', []) %}
                  <tr>
                    <td><strong>{{ "{:,}".format(d.get('price', 0)).replace(",", " ") }} &euro;</strong></td>
                    <td>{{ d.get('year', '-') or '-' }}</td>
                    <td>{{ "{:,}".format(d.get('km', 0)).replace(",", " ") ~ ' km' if d.get('km') else '-' }}</td>
                    <td>{{ d.get('fuel', '-') or '-' }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="d-flex flex-wrap gap-1">
              {% for p in details.get('kept_prices', []) %}
              <span class="badge bg-success bg-opacity-75" style="font-size:12px">
                {{ "{:,}".format(p).replace(",", " ") }} &euro;
              </span>
              {% endfor %}
            </div>
            {% endif %}
          </div>

          <!-- Prix exclus -->
          {% if details.get('excluded_prices') %}
          <div class="mb-3">
            <h6>Prix exclus (outliers)</h6>
            {% if details.get('excluded_details') %}
            <div class="table-responsive">
              <table class="table table-sm mb-0" style="font-size:12px">
                <thead class="table-light">
                  <tr>
                    <th>Prix</th>
                    <th>Annee</th>
                    <th>Km</th>
                    <th>Motorisation</th>
                  </tr>
                </thead>
                <tbody>
                  {% for d in details.get('excluded_details', []) %}
                  <tr class="text-decoration-line-through text-danger">
                    <td><strong>{{ "{:,}".format(d.get('price', 0)).replace(",", " ") }} &euro;</strong></td>
                    <td>{{ d.get('year', '-') or '-' }}</td>
                    <td>{{ "{:,}".format(d.get('km', 0)).replace(",", " ") ~ ' km' if d.get('km') else '-' }}</td>
                    <td>{{ d.get('fuel', '-') or '-' }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="d-flex flex-wrap gap-1">
              {% for p in details.get('excluded_prices', []) %}
              <span class="badge bg-danger bg-opacity-75" style="font-size:12px; text-decoration: line-through">
                {{ "{:,}".format(p).replace(",", " ") }} &euro;
              </span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          {% endif %}

          <!-- Stats finales -->
          <div class="mt-3 p-2" style="background:#f0fdf4; border-radius:8px; border:1px solid #bbf7d0">
            <strong>Stats calculees (sur prix retenus) :</strong>
            <div class="row mt-2">
              <div class="col-2 text-center">
                <div style="font-size:11px; color:#6b7280">Min</div>
                <strong>{{ "{:,}".format(m.price_min).replace(",", " ") }} &euro;</strong>
              </div>
              <div class="col-2 text-center">
                <div style="font-size:11px; color:#22c55e">P25</div>
                <strong style="color:#22c55e">{{ "{:,}".format(m.price_p25 or m.price_min).replace(",", " ") }} &euro;</strong>
              </div>
              <div class="col-2 text-center">
                <div style="font-size:11px; color:#8b5cf6">IQR Mean</div>
                <strong style="color:#8b5cf6; font-size:1.1em">{{ "{:,}".format(m.price_iqr_mean or m.price_median).replace(",", " ") }} &euro;</strong>
              </div>
              <div class="col-2 text-center">
                <div style="font-size:11px; color:#6b7280">Mediane</div>
                <strong>{{ "{:,}".format(m.price_median).replace(",", " ") }} &euro;</strong>
              </div>
              <div class="col-2 text-center">
                <div style="font-size:11px; color:#f59e0b">P75</div>
                <strong style="color:#f59e0b">{{ "{:,}".format(m.price_p75 or m.price_max).replace(",", " ") }} &euro;</strong>
              </div>
              <div class="col-2 text-center">
                <div style="font-size:11px; color:#6b7280">Max</div>
                <strong>{{ "{:,}".format(m.price_max).replace(",", " ") }} &euro;</strong>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  {% endfor %}

  <!-- Pagination -->
  {% if total_pages > 1 %}
  <nav class="mt-3">
    <ul class="pagination pagination-sm justify-content-center mb-0">
      {% if page > 1 %}
      <li class="page-item">
        <a class="page-link" href="?make={{ make_filter }}&region={{ region_filter }}&page={{ page - 1 }}">&laquo;</a>
      </li>
      {% endif %}
      {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
        <li class="page-item active"><span class="page-link">{{ p }}</span></li>
        {% elif (p - page)|abs <= 2 or p == 1 or p == total_pages %}
        <li class="page-item">
          <a class="page-link" href="?make={{ make_filter }}&region={{ region_filter }}&page={{ p }}">{{ p }}</a>
        </li>
        {% elif (p - page)|abs == 3 %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
      {% endfor %}
      {% if page < total_pages %}
      <li class="page-item">
        <a class="page-link" href="?make={{ make_filter }}&region={{ region_filter }}&page={{ page + 1 }}">&raquo;</a>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

  {% else %}
  <p class="text-muted text-center py-5">
    Aucun prix collecte{% if make_filter or region_filter %} pour ces filtres{% endif %}.<br>
    <small>Les prix seront collectes automatiquement par les utilisateurs de l'extension.</small>
  </p>
  {% endif %}
</div>

<!-- Argus insuffisant : donnees collectees mais en dessous du seuil -->
{% if insufficient_argus %}
<div class="stat-card mt-4" style="border-left:4px solid #f59e0b">
  <h5 class="mb-3">
    Argus insuffisant
    <span class="badge bg-warning text-dark">{{ insufficient_argus|length }}</span>
    <small class="text-muted ms-2" style="font-size:12px">
      Donnees collectees mais pas assez d'annonces pour un argus fiable. Scanner ces vehicules sur LBC pour completer.
    </small>
  </h5>
  <div class="table-responsive">
    <table class="table table-sm table-hover mb-0">
      <thead>
        <tr>
          <th>Vehicule</th>
          <th>Region</th>
          <th>Motorisation</th>
          <th class="text-center" title="Nombre d'annonces collectees">Collectees</th>
          <th class="text-center" title="Nombre minimum requis pour un argus fiable">Requis</th>
          <th class="text-center" title="Annonces manquantes">Deficit</th>
          <th class="text-end" title="Prix median actuel (indicatif, fiabilite limitee)">Median indicatif</th>
          <th class="text-center">Precision</th>
          <th>Derniere collecte</th>
        </tr>
      </thead>
      <tbody>
        {% for a in insufficient_argus %}
        <tr>
          <td><strong>{{ a.make }}</strong> {{ a.model }} <span class="text-muted" style="font-size:12px">{{ a.year }}</span></td>
          <td>{{ a.region }}</td>
          <td>{{ a.fuel or '-' }}</td>
          <td class="text-center">
            <span class="badge bg-warning text-dark">{{ a.sample_count }}</span>
          </td>
          <td class="text-center">
            <span class="badge bg-secondary">{{ a.min_required }}</span>
          </td>
          <td class="text-center">
            <span style="color:#ef4444; font-weight:bold">-{{ a.deficit }}</span>
          </td>
          <td class="text-end" style="font-size:12px; color:#9ca3af" title="Indicatif seulement -- fiabilite limitee avec {{ a.sample_count }} annonces">
            {{ "{:,}".format(a.price_iqr_mean or a.price_median).replace(",", " ") }} &euro; *
          </td>
          <td class="text-center">
            {% if a.precision %}
              {% set ap_colors = {5: 'success', 4: 'success', 3: 'info', 2: 'warning', 1: 'danger'} %}
              <span class="badge bg-{{ ap_colors.get(a.precision, 'secondary') }}">
                {{ '\u2605' * a.precision }}{{ '\u2606' * (5 - a.precision) }}
              </span>
            {% else %}
              <span class="text-muted" style="font-size:11px">-</span>
            {% endif %}
          </td>
          <td style="font-size:12px; white-space:nowrap">
            {{ a.collected_at.strftime('%d/%m/%Y') if a.collected_at else '-' }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <small class="text-muted mt-2 d-block">* Prix indicatif : fiabilite limitee. Scannez plus d'annonces LBC pour ces vehicules afin d'atteindre le seuil requis.</small>
</div>
{% endif %}

<!-- Seuils dynamiques par vehicule : transparence totale -->
<div class="stat-card mt-4">
  <h5 class="mb-3">
    Seuils argus par vehicule
    <small class="text-muted ms-2" style="font-size:12px">
      Le seuil minimum d'annonces est dynamique : standard (20), niche 300ch+ (10), ultra-niche 420ch+ (5). Override possible.
    </small>
  </h5>

  <div class="row mb-3">
    <div class="col-md-4">
      <div class="p-2" style="background:#f0fdf4; border-radius:6px; border:1px solid #bbf7d0; font-size:13px">
        <strong style="color:#22c55e">Standard</strong> : &lt; 300 ch &rarr; 20 annonces minimum
      </div>
    </div>
    <div class="col-md-4">
      <div class="p-2" style="background:#fefce8; border-radius:6px; border:1px solid #fde68a; font-size:13px">
        <strong style="color:#f59e0b">Niche</strong> : 300-420 ch &rarr; 10 annonces minimum
      </div>
    </div>
    <div class="col-md-4">
      <div class="p-2" style="background:#fef2f2; border-radius:6px; border:1px solid #fecaca; font-size:13px">
        <strong style="color:#ef4444">Ultra-niche</strong> : 420+ ch &rarr; 5 annonces minimum
      </div>
    </div>
  </div>

  <div class="table-responsive" style="max-height:500px; overflow-y:auto">
    <table class="table table-sm table-hover mb-0" style="font-size:13px">
      <thead class="table-light" style="position:sticky; top:0">
        <tr>
          <th>Vehicule</th>
          <th class="text-center" title="Puissance max dans les specs CSV">Puissance max</th>
          <th class="text-center">Segment</th>
          <th class="text-center" title="Seuil calcule automatiquement">Seuil auto</th>
          <th class="text-center" title="Override admin (prioritaire)">Override</th>
          <th class="text-center" title="Seuil effectif utilise">Effectif</th>
          <th class="text-center" title="Nombre de MarketPrice existants">Argus existants</th>
          <th>Modifier</th>
        </tr>
      </thead>
      <tbody>
        {% for vt in vehicle_thresholds %}
        <tr style="{% if vt.override %}background:#eff6ff{% endif %}">
          <td><strong>{{ vt.brand }}</strong> {{ vt.model }}</td>
          <td class="text-center">
            {% if vt.max_hp %}
              {{ vt.max_hp }} ch
            {% else %}
              <span class="text-muted">?</span>
            {% endif %}
          </td>
          <td class="text-center">
            {% if vt.tier == 'ultra-niche' %}
              <span class="badge bg-danger">Ultra-niche</span>
            {% elif vt.tier == 'niche' %}
              <span class="badge bg-warning text-dark">Niche</span>
            {% else %}
              <span class="badge bg-secondary">Standard</span>
            {% endif %}
          </td>
          <td class="text-center">{{ vt.dynamic_min }}</td>
          <td class="text-center">
            {% if vt.override is not none %}
              <span class="badge bg-info">{{ vt.override }}</span>
            {% else %}
              <span class="text-muted">auto</span>
            {% endif %}
          </td>
          <td class="text-center"><strong>{{ vt.effective_min }}</strong></td>
          <td class="text-center">
            {% if vt.market_count > 0 %}
              <span class="badge bg-success">{{ vt.market_count }}</span>
            {% else %}
              <span class="text-muted">0</span>
            {% endif %}
          </td>
          <td>
            <form method="POST" action="{{ url_for('admin.set_argus_threshold', vehicle_id=vt.id) }}"
                  style="display:inline" class="d-flex gap-1 align-items-center">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="number" name="threshold" min="1" max="100"
                     value="{{ vt.override if vt.override is not none else '' }}"
                     placeholder="auto"
                     class="form-control form-control-sm" style="width:70px; font-size:12px">
              <button type="submit" class="btn btn-sm btn-outline-primary" style="font-size:11px" title="Appliquer ce seuil">OK</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <small class="text-muted mt-2 d-block">Laissez vide et cliquez OK pour remettre en mode automatique. Le seuil effectif = override si defini, sinon calcul dynamique par puissance.</small>
</div>

{% if get_flashed_messages() %}
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080;">
  {% for category, message in get_flashed_messages(with_categories=true) %}
  <div class="alert alert-{{ 'success' if category == 'success' else ('warning' if category == 'warning' else 'danger') }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endfor %}
</div>
{% endif %}
{% endblock %}
