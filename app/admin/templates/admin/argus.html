{% extends "admin/base.html" %}
{% block title %}Argus maison - Co-Pilot Admin{% endblock %}

{% block content %}
<h2 class="mb-4">Argus maison</h2>
<p class="text-muted mb-4">Prix du marche collectes par les utilisateurs de l'extension Chrome (crowdsourcing).</p>

<!-- Stats resume -->
<div class="row g-3 mb-4">
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value">{{ total_refs }}</div>
      <div class="stat-label">References prix</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value" style="color: #22c55e;">{{ fresh_refs }}</div>
      <div class="stat-label">Frais (< 24h)</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value" style="color: #f59e0b;">{{ stale_refs }}</div>
      <div class="stat-label">A rafraichir</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value" style="color: #8b5cf6;">{{ total_samples }}</div>
      <div class="stat-label">Annonces collectees</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value">{{ distinct_makes }}</div>
      <div class="stat-label">Marques couvertes</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="stat-card">
      <div class="stat-value">{{ distinct_regions }}</div>
      <div class="stat-label">Regions couvertes</div>
    </div>
  </div>
</div>

<!-- Filtres -->
<div class="stat-card mb-4">
  <form method="get" class="row g-2 align-items-end">
    <div class="col-md-3">
      <label class="form-label mb-1" style="font-size:13px">Marque</label>
      <select name="make" class="form-select form-select-sm">
        <option value="">Toutes</option>
        {% for m in make_list %}
        <option value="{{ m }}" {% if m == make_filter %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label mb-1" style="font-size:13px">Region</label>
      <select name="region" class="form-select form-select-sm">
        <option value="">Toutes</option>
        {% for r in region_list %}
        <option value="{{ r }}" {% if r == region_filter %}selected{% endif %}>{{ r }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-sm btn-primary">Filtrer</button>
      {% if make_filter or region_filter %}
      <a href="{{ url_for('admin.argus') }}" class="btn btn-sm btn-outline-secondary">Reset</a>
      {% endif %}
    </div>
    <div class="col-md-4 text-end text-muted" style="font-size:13px">
      {{ total_results }} resultat{{ 's' if total_results != 1 else '' }}
    </div>
  </form>
</div>

<!-- Table des prix -->
<div class="stat-card">
  {% if records %}
  <div class="table-responsive">
    <table class="table table-sm table-hover mb-0">
      <thead>
        <tr>
          <th>Collecte</th>
          <th>Vehicule</th>
          <th>Region</th>
          <th class="text-end" title="Moyenne Interquartile (50% central)">IQR Mean</th>
          <th class="text-end" title="Percentile 25 (bonne affaire)">P25</th>
          <th class="text-end">Median</th>
          <th class="text-end" title="Percentile 75 (cher)">P75</th>
          <th class="text-end">Min</th>
          <th class="text-end">Max</th>
          <th class="text-center">Annonces</th>
          <th class="text-center">Precision</th>
          <th class="text-center">Fraicheur</th>
          <th class="text-center">Detail</th>
        </tr>
      </thead>
      <tbody>
        {% for m in records %}
        {% set is_fresh = m.refresh_after > now %}
        {% set details = m.get_calculation_details() %}
        <tr>
          <td style="font-size:12px; white-space:nowrap">
            {{ (m.collected_at|localtime).strftime('%d/%m/%Y %H:%M') if m.collected_at else '-' }}
          </td>
          <td>
            <strong>{{ m.make }}</strong> {{ m.model }}
            <span class="text-muted" style="font-size:12px">{{ m.year }}</span>
          </td>
          <td>{{ m.region }}</td>
          <td class="text-end"><strong>{{ "{:,}".format(m.price_iqr_mean or m.price_median).replace(",", " ") }} &euro;</strong></td>
          <td class="text-end" style="font-size:12px; color:#22c55e">{{ "{:,}".format(m.price_p25 or m.price_min).replace(",", " ") }} &euro;</td>
          <td class="text-end" style="font-size:12px">{{ "{:,}".format(m.price_median).replace(",", " ") }} &euro;</td>
          <td class="text-end" style="font-size:12px; color:#f59e0b">{{ "{:,}".format(m.price_p75 or m.price_max).replace(",", " ") }} &euro;</td>
          <td class="text-end" style="font-size:12px">{{ "{:,}".format(m.price_min).replace(",", " ") }} &euro;</td>
          <td class="text-end" style="font-size:12px">{{ "{:,}".format(m.price_max).replace(",", " ") }} &euro;</td>
          <td class="text-center"><span class="badge bg-primary">{{ m.sample_count }}</span></td>
          <td class="text-center">
            {% if m.precision %}
              {% set prec_colors = {5: 'success', 4: 'success', 3: 'info', 2: 'warning', 1: 'danger'} %}
              {% set prec_labels = {5: 'Tres precis', 4: 'Precis', 3: 'Correct', 2: 'Approx.', 1: 'Estimatif'} %}
              <span class="badge bg-{{ prec_colors.get(m.precision, 'secondary') }}" title="{{ prec_labels.get(m.precision, '') }}">
                {{ '\u2605' * m.precision }}{{ '\u2606' * (5 - m.precision) }}
              </span>
            {% else %}
              <span class="text-muted" style="font-size:11px">-</span>
            {% endif %}
          </td>
          <td class="text-center">
            {% if is_fresh %}
              <span class="badge bg-success">Frais</span>
            {% else %}
              <span class="badge bg-warning text-dark">A rafraichir</span>
            {% endif %}
          </td>
          <td class="text-center">
            {% if details %}
            <button class="btn btn-sm btn-outline-secondary"
                    data-bs-toggle="modal"
                    data-bs-target="#detailModal{{ m.id }}"
                    title="Voir le detail du calcul">
              <small>Voir</small>
            </button>
            {% else %}
            <span class="text-muted" style="font-size:11px">-</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Modales de detail -->
  {% for m in records %}
  {% set details = m.get_calculation_details() %}
  {% if details %}
  <div class="modal fade" id="detailModal{{ m.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            Detail du calcul &mdash; {{ m.make }} {{ m.model }} {{ m.year }} ({{ m.region }})
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <!-- Methode + Precision -->
          <div class="mb-3">
            <span class="badge bg-info">Methode : {{ details.get('method', 'inconnue') | upper }}</span>
            <span class="badge bg-secondary">{{ details.get('raw_count', '?') }} annonces collectees</span>
            <span class="badge bg-success">{{ details.get('kept_count', '?') }} retenues</span>
            {% if details.get('excluded_count', 0) > 0 %}
            <span class="badge bg-danger">{{ details.get('excluded_count', 0) }} exclues</span>
            {% endif %}
            {% if details.get('precision') %}
            {% set dp = details.get('precision') %}
            {% set dp_colors = {5: 'success', 4: 'success', 3: 'info', 2: 'warning', 1: 'danger'} %}
            {% set dp_labels = {5: 'Tres precis', 4: 'Precis', 3: 'Correct', 2: 'Approx.', 1: 'Estimatif'} %}
            <span class="badge bg-{{ dp_colors.get(dp, 'secondary') }}">
              Precision : {{ '\u2605' * dp }}{{ '\u2606' * (5 - dp) }} {{ dp }}/5 &ndash; {{ dp_labels.get(dp, '') }}
            </span>
            {% endif %}
          </div>

          <!-- Bornes IQR -->
          <div class="mb-3 p-2" style="background:#f8f9fa; border-radius:8px">
            <strong>Bornes IQR :</strong>
            {{ "{:,.0f}".format(details.get('iqr_low', 0)).replace(",", " ") }} &euro;
            &mdash;
            {{ "{:,.0f}".format(details.get('iqr_high', 0)).replace(",", " ") }} &euro;
            <br>
            <small class="text-muted">Les prix en dehors de ces bornes sont exclus du calcul (outliers).</small>
          </div>

          <!-- Prix gardes -->
          <div class="mb-3">
            <h6>Prix retenus ({{ details.get('kept_count', 0) }})</h6>
            {% if details.get('kept_details') %}
            <div class="table-responsive" style="max-height:300px; overflow-y:auto">
              <table class="table table-sm table-striped mb-0" style="font-size:12px">
                <thead class="table-light">
                  <tr>
                    <th>Prix</th>
                    <th>Annee</th>
                    <th>Km</th>
                    <th>Motorisation</th>
                  </tr>
                </thead>
                <tbody>
                  {% for d in details.get('kept_details', []) %}
                  <tr>
                    <td><strong>{{ "{:,}".format(d.get('price', 0)).replace(",", " ") }} &euro;</strong></td>
                    <td>{{ d.get('year', '-') or '-' }}</td>
                    <td>{{ "{:,}".format(d.get('km', 0)).replace(",", " ") ~ ' km' if d.get('km') else '-' }}</td>
                    <td>{{ d.get('fuel', '-') or '-' }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="d-flex flex-wrap gap-1">
              {% for p in details.get('kept_prices', []) %}
              <span class="badge bg-success bg-opacity-75" style="font-size:12px">
                {{ "{:,}".format(p).replace(",", " ") }} &euro;
              </span>
              {% endfor %}
            </div>
            {% endif %}
          </div>

          <!-- Prix exclus -->
          {% if details.get('excluded_prices') %}
          <div class="mb-3">
            <h6>Prix exclus (outliers)</h6>
            {% if details.get('excluded_details') %}
            <div class="table-responsive">
              <table class="table table-sm mb-0" style="font-size:12px">
                <thead class="table-light">
                  <tr>
                    <th>Prix</th>
                    <th>Annee</th>
                    <th>Km</th>
                    <th>Motorisation</th>
                  </tr>
                </thead>
                <tbody>
                  {% for d in details.get('excluded_details', []) %}
                  <tr class="text-decoration-line-through text-danger">
                    <td><strong>{{ "{:,}".format(d.get('price', 0)).replace(",", " ") }} &euro;</strong></td>
                    <td>{{ d.get('year', '-') or '-' }}</td>
                    <td>{{ "{:,}".format(d.get('km', 0)).replace(",", " ") ~ ' km' if d.get('km') else '-' }}</td>
                    <td>{{ d.get('fuel', '-') or '-' }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="d-flex flex-wrap gap-1">
              {% for p in details.get('excluded_prices', []) %}
              <span class="badge bg-danger bg-opacity-75" style="font-size:12px; text-decoration: line-through">
                {{ "{:,}".format(p).replace(",", " ") }} &euro;
              </span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          {% endif %}

          <!-- Stats finales -->
          <div class="mt-3 p-2" style="background:#f0fdf4; border-radius:8px; border:1px solid #bbf7d0">
            <strong>Stats calculees (sur prix retenus) :</strong>
            <div class="row mt-2">
              <div class="col-2 text-center">
                <div style="font-size:11px; color:#6b7280">Min</div>
                <strong>{{ "{:,}".format(m.price_min).replace(",", " ") }} &euro;</strong>
              </div>
              <div class="col-2 text-center">
                <div style="font-size:11px; color:#22c55e">P25</div>
                <strong style="color:#22c55e">{{ "{:,}".format(m.price_p25 or m.price_min).replace(",", " ") }} &euro;</strong>
              </div>
              <div class="col-2 text-center">
                <div style="font-size:11px; color:#8b5cf6">IQR Mean</div>
                <strong style="color:#8b5cf6; font-size:1.1em">{{ "{:,}".format(m.price_iqr_mean or m.price_median).replace(",", " ") }} &euro;</strong>
              </div>
              <div class="col-2 text-center">
                <div style="font-size:11px; color:#6b7280">Mediane</div>
                <strong>{{ "{:,}".format(m.price_median).replace(",", " ") }} &euro;</strong>
              </div>
              <div class="col-2 text-center">
                <div style="font-size:11px; color:#f59e0b">P75</div>
                <strong style="color:#f59e0b">{{ "{:,}".format(m.price_p75 or m.price_max).replace(",", " ") }} &euro;</strong>
              </div>
              <div class="col-2 text-center">
                <div style="font-size:11px; color:#6b7280">Max</div>
                <strong>{{ "{:,}".format(m.price_max).replace(",", " ") }} &euro;</strong>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  {% endfor %}

  <!-- Pagination -->
  {% if total_pages > 1 %}
  <nav class="mt-3">
    <ul class="pagination pagination-sm justify-content-center mb-0">
      {% if page > 1 %}
      <li class="page-item">
        <a class="page-link" href="?make={{ make_filter }}&region={{ region_filter }}&page={{ page - 1 }}">&laquo;</a>
      </li>
      {% endif %}
      {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
        <li class="page-item active"><span class="page-link">{{ p }}</span></li>
        {% elif (p - page)|abs <= 2 or p == 1 or p == total_pages %}
        <li class="page-item">
          <a class="page-link" href="?make={{ make_filter }}&region={{ region_filter }}&page={{ p }}">{{ p }}</a>
        </li>
        {% elif (p - page)|abs == 3 %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
      {% endfor %}
      {% if page < total_pages %}
      <li class="page-item">
        <a class="page-link" href="?make={{ make_filter }}&region={{ region_filter }}&page={{ page + 1 }}">&raquo;</a>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

  {% else %}
  <p class="text-muted text-center py-5">
    Aucun prix collecte{% if make_filter or region_filter %} pour ces filtres{% endif %}.<br>
    <small>Les prix seront collectes automatiquement par les utilisateurs de l'extension.</small>
  </p>
  {% endif %}
</div>
{% endblock %}
