{% extends "admin/base.html" %}
{% block title %}Dashboard - Co-Pilot Admin{% endblock %}

{% block content %}
<h2 class="mb-4">Dashboard</h2>

<!-- Cartes statistiques -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="stat-card">
      <div class="stat-value">{{ total_scans }}</div>
      <div class="stat-label">Scans totaux</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card">
      <div class="stat-value">{{ scans_today }}</div>
      <div class="stat-label">Scans aujourd'hui</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card">
      <div class="stat-value">{{ avg_score }}<small>/100</small></div>
      <div class="stat-label">Score moyen</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card">
      <div class="stat-value">{{ partial_rate }}%</div>
      <div class="stat-label">Analyses partielles</div>
    </div>
  </div>
</div>

<!-- Cartes statistiques -- ligne 2 -->
<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="stat-card">
      <div class="stat-value" style="color: #ef4444;">{{ fail_rate }}%</div>
      <div class="stat-label">Taux d'echec (scans avec fail)</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="stat-card">
      <div class="stat-value" style="color: #f59e0b;">{{ warning_count }}</div>
      <div class="stat-label">Avertissements filtres</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="stat-card">
      <div class="stat-value" style="color: #dc2626;">{{ error_count }}</div>
      <div class="stat-label">Erreurs applicatives</div>
    </div>
  </div>
</div>

<!-- Carte referentiel : vehicules non reconnus -->
<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="stat-card">
      <div class="stat-value" style="color: {% if unrecognized_count > 5 %}#ef4444{% elif unrecognized_count > 0 %}#f59e0b{% else %}#22c55e{% endif %};">
        {{ unrecognized_count }}
      </div>
      <div class="stat-label">
        <a href="{{ url_for('admin.car') }}" style="text-decoration:none; color:#64748b;">
          Vehicules non reconnus &rarr;
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Graphiques ligne 1 -->
<div class="row g-3 mb-3">
  <div class="col-md-7">
    <div class="stat-card">
      <h5>Scans par jour (30 derniers jours)</h5>
      <div id="chart-daily"></div>
    </div>
  </div>
  <div class="col-md-5">
    <div class="stat-card">
      <h5>Distribution des scores</h5>
      <div id="chart-scores"></div>
    </div>
  </div>
</div>

<!-- Graphiques ligne 2 : performance filtres + top vehicules -->
<div class="row g-3 mb-3">
  <div class="col-md-7">
    <div class="stat-card">
      <h5>Performance des filtres</h5>
      <div id="chart-filters"></div>
    </div>
  </div>
  <div class="col-md-5">
    <div class="stat-card">
      <h5>Vehicules les plus analyses</h5>
      {% if top_vehicles %}
      <table class="table table-sm mb-0">
        <thead><tr><th>Marque</th><th>Modele</th><th>Scans</th></tr></thead>
        <tbody>
          {% for v in top_vehicles %}
          <tr>
            <td>{{ v.vehicle_make }}</td>
            <td>{{ v.vehicle_model or '-' }}</td>
            <td><span class="badge bg-primary">{{ v.count }}</span></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-muted text-center py-5">Aucune donnee</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Argus maison (prix du marche crowdsources) -->
<div class="row g-3 mb-3">
  <div class="col-md-4">
    <div class="stat-card">
      <div class="stat-value">{{ market_total }}</div>
      <div class="stat-label">References prix (argus maison)</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="stat-card">
      <div class="stat-value" style="color: #22c55e;">{{ market_fresh }}</div>
      <div class="stat-label">Frais (< 24h)</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="stat-card">
      <div class="stat-value" style="color: #8b5cf6;">{{ market_total_samples }}</div>
      <div class="stat-label">Annonces collectees (total)</div>
    </div>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-12">
    <div class="stat-card">
      <h5>Argus maison -- derniers prix collectes</h5>
      {% if recent_market %}
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
          <thead><tr><th>Collecte</th><th>Vehicule</th><th>Region</th><th>Median</th><th>Min</th><th>Max</th><th>Annonces</th><th>Fraicheur</th></tr></thead>
          <tbody>
            {% for m in recent_market %}
            {% set is_fresh = m.refresh_after > now %}
            <tr>
              <td style="font-size:12px; white-space:nowrap">{{ m.collected_at.strftime('%d/%m %H:%M') if m.collected_at else '-' }}</td>
              <td><strong>{{ m.make }}</strong> {{ m.model }} {{ m.year }}</td>
              <td>{{ m.region }}</td>
              <td><strong>{{ "{:,}".format(m.price_median).replace(",", " ") }} &euro;</strong></td>
              <td style="font-size:12px">{{ "{:,}".format(m.price_min).replace(",", " ") }} &euro;</td>
              <td style="font-size:12px">{{ "{:,}".format(m.price_max).replace(",", " ") }} &euro;</td>
              <td><span class="badge bg-primary">{{ m.sample_count }}</span></td>
              <td>
                {% if is_fresh %}
                  <span class="badge bg-success">Frais</span>
                {% else %}
                  <span class="badge bg-warning text-dark">A rafraichir</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted text-center py-4">Aucun prix collecte. Les prix seront collectes automatiquement par les utilisateurs de l'extension.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Derniers scans -->
<div class="row g-3">
  <div class="col-12">
    <div class="stat-card">
      <h5>10 derniers scans</h5>
      {% if recent_scans %}
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
          <thead><tr><th>Date</th><th>Vehicule</th><th>URL</th><th>Score</th><th>Partiel</th></tr></thead>
          <tbody>
            {% for s in recent_scans %}
            <tr>
              <td style="font-size:12px; white-space:nowrap">{{ s.created_at.strftime('%d/%m %H:%M') if s.created_at else '-' }}</td>
              <td>{{ s.vehicle_make or '' }} {{ s.vehicle_model or '' }}</td>
              <td style="font-size:12px; max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                {% if s.url %}<a href="{{ s.url }}" target="_blank" rel="noopener">{{ s.url[:60] }}{% if s.url|length > 60 %}...{% endif %}</a>{% else %}-{% endif %}
              </td>
              <td><strong>{{ s.score }}/100</strong></td>
              <td>{% if s.is_partial %}<span class="badge bg-warning text-dark">Oui</span>{% else %}<span class="badge bg-success">Non</span>{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted text-center py-5">Aucun scan enregistre</p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Graphique scans par jour
  const days = {{ chart_days|safe }};
  const counts = {{ chart_counts|safe }};

  if (days.length > 0) {
    Plotly.newPlot("chart-daily", [{
      x: days,
      y: counts,
      type: "bar",
      marker: { color: "#3b82f6" }
    }], {
      margin: { t: 10, r: 20, b: 40, l: 40 },
      xaxis: { title: "" },
      yaxis: { title: "Scans" },
      height: 300
    }, { responsive: true, displayModeBar: false });
  } else {
    document.getElementById("chart-daily").innerHTML =
      '<p class="text-muted text-center py-5">Aucun scan enregistre</p>';
  }

  // Graphique distribution des scores
  const scores = {{ score_values|safe }};

  if (scores.length > 0) {
    Plotly.newPlot("chart-scores", [{
      x: scores,
      type: "histogram",
      xbins: { start: 0, end: 100, size: 10 },
      marker: { color: "#22c55e" }
    }], {
      margin: { t: 10, r: 20, b: 40, l: 40 },
      xaxis: { title: "Score", range: [0, 100] },
      yaxis: { title: "Nombre" },
      height: 300
    }, { responsive: true, displayModeBar: false });
  } else {
    document.getElementById("chart-scores").innerHTML =
      '<p class="text-muted text-center py-5">Aucun score disponible</p>';
  }

  // Graphique performance des filtres (stacked bar)
  const filterPerf = {{ filter_perf|safe }};
  const filterIds = Object.keys(filterPerf).sort();

  if (filterIds.length > 0) {
    const labels = {
      L1: "Completude", L2: "Referentiel", L3: "Coherence",
      L4: "Prix Argus", L5: "Statistique", L6: "Telephone",
      L7: "SIRET", L8: "Import", L9: "Global"
    };
    const xLabels = filterIds.map(fid => labels[fid] || fid);
    const traces = ["pass", "warning", "fail", "skip"].map(status => ({
      x: xLabels,
      y: filterIds.map(fid => filterPerf[fid][status] || 0),
      name: status,
      type: "bar",
      marker: {
        color: { pass: "#22c55e", warning: "#f59e0b", fail: "#ef4444", skip: "#9ca3af" }[status]
      }
    }));
    Plotly.newPlot("chart-filters", traces, {
      barmode: "stack",
      margin: { t: 10, r: 20, b: 60, l: 40 },
      height: 300,
      legend: { orientation: "h", y: -0.25 }
    }, { responsive: true, displayModeBar: false });
  } else {
    document.getElementById("chart-filters").innerHTML =
      '<p class="text-muted text-center py-5">Aucune donnee de filtre</p>';
  }
</script>
{% endblock %}
